---
language: generic
services:
  - docker

env:
  global:
    # - HUB_LOGIN=
    # - HUB_PASSWORD=
    # - REPO_NAME=
    - COMMIT=${TRAVIS_COMMIT:0:8}

before_install:
  - docker pull $REPO_NAME/mail:latest
  - docker pull $REPO_NAME/mail:debug

script:
  - docker build -t mail:latest --cache-from=$REPO_NAME/mail:latest -f $TRAVIS_BUILD_DIR/latest/Dockerfile   $TRAVIS_BUILD_DIR
  - docker build -t mail:debug  --cache-from=$REPO_NAME/mail:debug  -f $TRAVIS_BUILD_DIR/debug/Dockerfile    $TRAVIS_BUILD_DIR

  - docker tag  mail:latest   $REPO_NAME/mail:latest
  - docker tag  mail:latest   $REPO_NAME/mail:$COMMIT
  - docker tag  mail:debug    $REPO_NAME/mail:debug
  - docker tag  mail:debug    $REPO_NAME/mail:debug-$COMMIT

before_deploy:
  - echo "$HUB_PASSWORD" | docker login --username "$HUB_LOGIN" --password-stdin

deploy:
  - provider: script
    on:
      branch: master
    script: $TRAVIS_BUILD_DIR/.travis/deploy.sh
